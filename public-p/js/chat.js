const params=new URL(document.location).searchParams,name=params.get("name"),socket=io();name?name.length<3||name.length>30?window.location.href="/landing?error=invalid":socket.emit("validateName",name):window.location.href="/landing";let clients=[],clientNames={},activeObj={},rooms=[],subscriptions={},ongoingSwitch=!1,activeRoomMembers={};const chats={},notifications={};let room_search_filter="",user_search_filter="";function getClientInfo(){socket.emit("getClientList"),socket.emit("getClientNames"),socket.emit("getRooms"),socket.emit("updateSubs"),socket.emit("getSubscriptions")}function refreshUsers(){let e;$("#user_search").nextAll().remove();let t=[];if(clients.forEach(o=>{if("user"===activeObj.type&&activeObj.id===o)e=o;else if(clientNames[o])if(o in notifications)t.push(o);else{let e=`<span class="invite ${!subscriptions[o]&&subscriptions[socket.id]?"on":"off"}" name="${o}">🗣️</span>`;$(".chats").append(`<p class='chatUser' style='display:${clientNames[o].includes(user_search_filter)?"block":"none"}' name="${o}">${clientNames[o]} 💬 ${e}</p>`)}}),e&&clientNames[e]){let o=`<span class="invite ${!subscriptions[e]&&subscriptions[socket.id]?"on":"off"}" name="${e}">🗣️</span>`;$("#user_search").after(`<p class='chatUser active' name=${e}>${clientNames[e]} 💬 ${o}</p>`),t.forEach(e=>{o=`<span class="invite ${!subscriptions[e]&&subscriptions[socket.id]?"on":"off"}" name="${e}">🗣️</span>`,$(".chatUser.active").after(`<p class='chatUser messageAlert' style='display:${clientNames[e].includes(user_search_filter)?"block":"none"}' name=${e}>${clientNames[e]} 💬 ${o}</p>`)})}else t.forEach(e=>{let t=`<span class="invite ${!subscriptions[e]&&subscriptions[socket.id]?"on":"off"}" name="${e}">🗣️</span>`;$("#user_search").after(`<p class='chatUser messageAlert' style='display:${clientNames[e].includes(user_search_filter)?"block":"none"}' name=${e}>${clientNames[e]} 💬 ${t}</p>`)});checkActiveChat()}function checkActiveChat(){const e=0===Object.keys(activeObj).length,t="user"===activeObj.type&&!clientNames[activeObj.id],o="room"===activeObj.type&&-1===rooms.findIndex(function(e,t){if(e.room_name===activeObj.id)return!0});e||t||o?($(".chat-input").hide(),$("#active_recipient").removeClass("badge-success"),$("#active_recipient").addClass("badge-danger"),$("#active_recipient").text("No User")):($(".chat-input").show(),$("#active_recipient").removeClass("badge-danger"),$("#active_recipient").addClass("badge-success"))}function refreshRooms(){let e;$(".create_room").nextAll().remove();let t=[],o=[];rooms.forEach(s=>{"room"===activeObj.type&&activeObj.id===s.room_name?e=s:s.room_name in notifications?t.push(s.room_name):s.room_name===subscriptions[socket.id]?o.push(s.room_name):$(".create_room").after(`<p class='room_tab' style='display:${s.room_name.includes(room_search_filter)?"block":"none"}' name="${s.room_name}">${s.room_name}</p>`)}),e?($(".create_room").after(`<p class='room_tab active' name="${e.room_name}">${e.room_name}</p>`),t.forEach(e=>{$(".room_tab.active").after(`<p class='room_tab messageAlert' style='display:${e.includes(room_search_filter)?"block":"none"}' name="${e}">${e}</p>`)}),o.forEach(e=>{$(".room_tab.active").after(`<p class='room_tab subbed' name="${e}">${e}</p>`)})):(t.forEach(e=>{$(".create_room").after(`<p class='room_tab messageAlert' style='display:${e.includes(room_search_filter)?"block":"none"}' name="${e}">${e}</p>`)}),o.forEach(e=>{$(".create_room").after(`<p class='room_tab subbed' name="${e}">${e}</p>`)})),checkActiveChat()}function sendMessage(){const e=$("#main-input"),t=e.val();Object.keys(activeObj).length>0&&t&&(socket.emit("sendMessage",activeObj,t),activeObj.id in chats||(chats[activeObj.id]=[]),chats[activeObj.id].push({incoming:!1,message:t}),"room"===activeObj.type&&(chats[activeObj.id].sender=socket.id),$(".chat-panel").append(msgBuilder(!1,t)),e.val(""),scrollToBottom("chat-panel"))}function switchChats(){$(".chat-panel").fadeOut(100),$(".chat-panel").children().remove(),activeObj.id in notifications&&delete notifications[activeObj.id];let e="room"===activeObj.type?activeObj.id:clientNames[activeObj.id],t=chats[activeObj.id];$("#active_recipient").text("Active Chat: "+e),t&&t.forEach(t=>{if(t.sender){let e=clientNames[t.sender];e&&$(".chat-panel").append(msgBuilder(t.incoming,t.message,e))}else $(".chat-panel").append(msgBuilder(t.incoming,t.message,e))}),scrollToBottom("chat-panel"),$(".chat-panel").fadeIn("slow")}function msgBuilder(e,t,o=null){let s=e?"incoming":"outgoing";return`<div class="row msgrow ${s}"><p class="msg ${s}">${o&&e?o+":":""} ${t}</p></div>`}function scrollToBottom(e){let t=document.getElementsByClassName(e)[0];t.scrollTop=t.scrollHeight-t.clientHeight}function chatUserAction(e){!ongoingSwitch&&$(e.target).attr("class").includes("chatUser")&&(ongoingSwitch=!0,activeObj={type:"user",id:$(this).attr("name")},$(".chatUser.active").removeClass("active"),$(".room_tab.active").removeClass("active"),$(this).addClass("active"),switchChats(),ongoingSwitch=!1)}function roomTabAction(){let e=$(this).attr("name");if(subscriptions[socket.id]===e)roomJoin(e);else if(subscriptions[socket.id])setSnack("You are already in a room!");else{let t=rooms.findIndex(function(t,o){if(t.room_name===e)return!0});if(-1!==t){let e=rooms[t];$("#room_modal").modal("show"),$(".body_join").css("display","block"),$(".body_create").css("display","none"),$("#join_room_id").val(e.room_name);let o=getRoomMembers(e.room_name);if($("#room_modal_title").text("Join Room: "+e.room_name),$("#read_room_owner").text("Owner: "+clientNames[e.owner]),$("#read_room_description").text("Description: "+e.description),$("#read_room_members").text("Capacity: "+e.member_count+"/"+e.capacity),o.length>0){let e="";o.forEach((t,o)=>{e+=`${o+1}- ${t}\n`}),$("#read_room_members_actual").text(e)}e.protected?$("#room_protected").css("display","block"):$("#room_protected").css("display","none")}}}function roomJoin(e){ongoingSwitch||(ongoingSwitch=!0,activeObj={type:"room",id:e},$(".chatUser.active").removeClass("active"),$(".room_tab.active").removeClass("active"),$(this).addClass("active"),switchChats(),ongoingSwitch=!1)}function createRoom(){$("#room_modal").modal("show"),$(".body_join").css("display","none"),$(".body_create").css("display","block"),$("#room_modal_title").text("Create Room")}function sendRoom(){"block"===$(".body_join").css("display")?socket.emit("joinRoom",{room:$("#join_room_id").val(),pw:$("#insert_room_pw").val()}):socket.emit("sendRoom",{room_name:$("#create_room_name").val(),description:$("#create_room_description").val(),capacity:$("#create_room_members").val(),password:$("#create_room_password").val()})}function updateRoomMembers(){let e=subscriptions[socket.id],t={};e&&Object.keys(subscriptions).forEach(o=>{if(subscriptions[o]===e&&o!==socket.id){let e=clientNames[o];e&&(t[o]=e)}}),activeRoomMembers=t}function getRoomMembers(e){let t=[];return Object.keys(subscriptions).forEach(o=>{subscriptions[o]===e&&clientNames[o]&&t.push(clientNames[o])}),t}function closeModal(e){const t=e.target.id;t&&$("#"+t).attr("class")&&$("#"+t).attr("class").split(" ").includes("modal")&&$("#"+t).modal("hide")}function updateActiveRoom(){$("#room_a_title").text(""),$("#room_a_desc").text(""),$("#room_a_cap").text(""),$("#members_action").html("");const e=subscriptions[socket.id];if(e){const t=rooms.findIndex(function(t,o){if(t.room_name===e)return!0}),o=rooms[t];$("#room_a_title").text(o.room_name),$("#room_a_desc").text(o.description),$("#room_a_cap").text(o.member_count+"/"+o.capacity);const s=o.owner===socket.id;if(s?$("#disband_room").parent().show():$("#disband_room").parent().hide(),Object.keys(activeRoomMembers).length>0){let e="";Object.keys(activeRoomMembers).forEach((t,o)=>{e+=`${o+1}- ${activeRoomMembers[t]}`,s&&(e+=`&nbsp;<button class="room_action kick_user" name="${t}">Kick 🚫</button><button class="room_action owner_transfer" name="${t}">Transfer Ownership 🛂</button>`),e+="<br>"}),$("#members_action").html(e)}}}function handleRoomAction(){const e=$(this).attr("class").split(" "),t=$(this).attr("id"),o=$(this).attr("name");t?"disband_room"===t?socket.emit("room_action",{action:"disband_room"}):"leave_room"===t&&socket.emit("room_action",{action:"leave_room"}):o?e.includes("owner_transfer")?socket.emit("room_action",{action:"owner_transfer",target:o}):e.includes("kick_user")&&socket.emit("room_action",{action:"kick_user",target:o}):setSnack("Something went wrong!")}function filterTab(e){const t="room_search"===e?".room_tab":".chatUser",o=$("#"+e).val();"room_search"===e?room_search_filter=o:user_search_filter=o,$(t).toArray().forEach(e=>{$(e).text().includes(o)||$(e).attr("class").includes("active")?$(e).css("display","block"):$(e).css("display","none")})}function filter(){filterTab(this.id)}function handleInvite(){let e=$(this).attr("name"),t=clientNames[e];t&&(setSnack(t+" has been invited to the room you are in!"),socket.emit("invitation",{target:subscriptions[socket.id],invited:e}))}function handleSnackInteraction(){let e=$(this).text();if(e.includes("You have been invited to a room(")){let t=e.split("(")[1];t&&(t=t.split(")")[0]),t&&t.length>0&&socket.emit("acceptInvitation",t)}}socket.on("validateNameResponse",function(e){e?(socket.emit("setName",name),$("#username").text(`${name}`)):window.location.href="/landing?error=taken"}),socket.on("updateClientList",function(e){clients=e}),socket.on("updateClientNames",function(e){clientNames=e,refreshUsers()}),socket.on("newmsg",function(e,t,o=null){if(o?!(!subscriptions[o]||o===socket.id):clientNames[e]){e in chats||(chats[e]=[]);let s={incoming:!0,message:t},n=null;o?(s.sender=o,(n=clientNames[o])&&setSnack("New message from "+n+", in room:"+e)):(s.sender=e,(n=clientNames[e])&&setSnack("New message from "+n)),chats[e].push(s),activeObj.id===e?($(".chat-panel").append(msgBuilder(!0,t,clientNames[s.sender])),scrollToBottom("chat-panel")):e in notifications||(notifications[e]=!0)}}),socket.on("sendRoomResponse",function(e){if(e.success)setSnack("Room created!"),$(".create_room").hide();else{let t="Couldn't create room, reason(s):";"many"===e.reason?(e.first||(t+="\nInvalid room name,room name must be at most 50 characters "),e.second||(t+="\nInvalid description,description must be at most 50 characters "),e.third||(t+="\nInvalid capacity,select a value between 1-100 "),e.fourth||(t+="\nRoom with given name already exists"),t+="\n\nOnly password field is allowed to be blank"):t+="\nCannot create/subscribe to more than one room",setSnack(t)}}),socket.on("updateRooms",function(e){rooms=e,refreshRooms()}),socket.on("updateSubs",function(e){(subscriptions=e)[socket.id]||$(".create_room").show(),updateRoomMembers(),updateActiveRoom()}),socket.on("joinRoomResponse",function(e){e.success?setSnack("Joined Successfully!"):setSnack("Couldn't join reason: "+e.reason)}),socket.on("room_action_response",function(e){e.success?setSnack("Success!"):setSnack("Failed, reason: "+e.reason)}),socket.on("roomalert",function(e){setSnack(e.message)}),socket.on("invitation",function(e){let t=e.from,o=e.toRoom,s=clientNames[t];s&&setSnack("You have been invited to a room("+o+") by "+s+".\nClick here to accept the invitation!")}),$(document).on("click",".room_tab",roomTabAction),$(document).on("click",".chatUser",chatUserAction),$(document).on("click","#send_msg",sendMessage),$(document).keyup(function(e){13==e.which&&$("#send_msg").click()}),$(document).on("click",".modal",closeModal),$(document).on("click",".create_room",createRoom),$(document).on("click","#room_ok",sendRoom),$(document).on("click",".room_action",handleRoomAction),$(document).on("click",".invite.on",handleInvite),$(document).on("click","#snackbar",handleSnackInteraction),$("#room_search,#user_search").on("input",filter),setInterval(getClientInfo,1e3);
